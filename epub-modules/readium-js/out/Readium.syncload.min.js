/**
 * almond 0.2.5 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

//  LauncherOSX
//
//  Created by Boris Schneiderman.
//  Copyright (c) 2012-2013 The Readium Foundation.
//
//  The Readium SDK is free software: you can redistribute it and/or modify
//  it under the terms of the GNU General Public License as published by
//  the Free Software Foundation, either version 3 of the License, or
//  (at your option) any later version.
//
//  This program is distributed in the hope that it will be useful,
//  but WITHOUT ANY WARRANTY; without even the implied warranty of
//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//  GNU General Public License for more details.
//
//  You should have received a copy of the GNU General Public License
//  along with this program.  If not, see <http://www.gnu.org/licenses/>.

//  Created by Boris Schneiderman.
//  Copyright (c) 2012-2013 The Readium Foundation.
//
//  The Readium SDK is free software: you can redistribute it and/or modify
//  it under the terms of the GNU General Public License as published by
//  the Free Software Foundation, either version 3 of the License, or
//  (at your option) any later version.
//
//  This program is distributed in the hope that it will be useful,
//  but WITHOUT ANY WARRANTY; without even the implied warranty of
//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//  GNU General Public License for more details.
//
//  You should have received a copy of the GNU General Public License
//  along with this program.  If not, see <http://www.gnu.org/licenses/>.

(function(e,t){e.Readium=t()})(this,function(){var e,t,n;(function(r){function d(e,t){return h.call(e,t)}function v(e,t){var n,r,i,s,o,u,a,f,c,h,p=t&&t.split("/"),d=l.map,v=d&&d["*"]||{};if(e&&e.charAt(0)===".")if(t){p=p.slice(0,p.length-1),e=p.concat(e.split("/"));for(f=0;f<e.length;f+=1){h=e[f];if(h===".")e.splice(f,1),f-=1;else if(h===".."){if(f===1&&(e[2]===".."||e[0]===".."))break;f>0&&(e.splice(f-1,2),f-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((p||v)&&d){n=e.split("/");for(f=n.length;f>0;f-=1){r=n.slice(0,f).join("/");if(p)for(c=p.length;c>0;c-=1){i=d[p.slice(0,c).join("/")];if(i){i=i[r];if(i){s=i,o=f;break}}}if(s)break;!u&&v&&v[r]&&(u=v[r],a=f)}!s&&u&&(s=u,o=a),s&&(n.splice(0,o,s),e=n.join("/"))}return e}function m(e,t){return function(){return s.apply(r,p.call(arguments,0).concat([e,t]))}}function g(e){return function(t){return v(t,e)}}function y(e){return function(t){a[e]=t}}function b(e){if(d(f,e)){var t=f[e];delete f[e],c[e]=!0,i.apply(r,t)}if(!d(a,e)&&!d(c,e))throw new Error("No "+e);return a[e]}function w(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function E(e){return function(){return l&&l.config&&l.config[e]||{}}}var i,s,o,u,a={},f={},l={},c={},h=Object.prototype.hasOwnProperty,p=[].slice;o=function(e,t){var n,r=w(e),i=r[0];return e=r[1],i&&(i=v(i,t),n=b(i)),i?n&&n.normalize?e=n.normalize(e,g(t)):e=v(e,t):(e=v(e,t),r=w(e),i=r[0],e=r[1],i&&(n=b(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},u={require:function(e){return m(e)},exports:function(e){var t=a[e];return typeof t!="undefined"?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:E(e)}}},i=function(e,t,n,i){var s,l,h,p,v,g=[],w;i=i||e;if(typeof n=="function"){t=!t.length&&n.length?["require","exports","module"]:t;for(v=0;v<t.length;v+=1){p=o(t[v],i),l=p.f;if(l==="require")g[v]=u.require(e);else if(l==="exports")g[v]=u.exports(e),w=!0;else if(l==="module")s=g[v]=u.module(e);else if(d(a,l)||d(f,l)||d(c,l))g[v]=b(l);else{if(!p.p)throw new Error(e+" missing "+l);p.p.load(p.n,m(i,!0),y(l),{}),g[v]=a[l]}}h=n.apply(a[e],g);if(e)if(s&&s.exports!==r&&s.exports!==a[e])a[e]=s.exports;else if(h!==r||!w)a[e]=h}else e&&(a[e]=n)},e=t=s=function(e,t,n,a,f){return typeof e=="string"?u[e]?u[e](t):b(o(e,t).f):(e.splice||(l=e,t.splice?(e=t,t=n,n=null):e=r),t=t||function(){},typeof n=="function"&&(n=a,a=f),a?i(r,e,t,n):setTimeout(function(){i(r,e,t,n)},4),s)},s.config=function(e){return l=e,l.deps&&s(l.deps,l.callback),s},n=function(e,t,n){t.splice||(n=t,t=[]),!d(a,e)&&!d(f,e)&&(f[e]=[e,t,n])},n.amd={jQuery:!0}})(),n("../../../build/almond",function(){}),n("jquery",[],function(){return jQuery}),n("underscore",[],function(){return _}),n("backbone",[],function(){return Backbone}),n("URIjs/URI",[],function(){return URI}),n("define-sync",function(){}),n("models/fetch_base",["backbone"],function(e){var t=e.Model.extend({_handleError:function(e){console.log(e),console.trace()},parseXml:function(e){return this.parseMarkup(e,"text/xml")},parseMarkup:function(e,t){var n=new window.DOMParser,r=n.parseFromString(e,t);return r}});return t}),n("models/discover_content_type",["require","module","jquery","backbone","URIjs/URI"],function(e,t,n,r,i){console.log("discover_content_type module id: "+t.id);var s=r.Model.extend({initialize:function(e){},identifyContentTypeFromFileName:function(e){var t=i(e).suffix(),n="application/octet-stream";return typeof this.constructor.suffixContentTypeMap[t]!="undefined"&&(n=this.constructor.suffixContentTypeMap[t]),n},identifyContentType:function(){var e=this.get("contentUrl"),t=n.ajax({type:"HEAD",url:e,async:!1}).getResponseHeader("Content-Type");return t===null&&(t=this.identifyContentTypeFromFileName(e),console.log("guessed contentType ["+t+"] from URI ["+e+"]. Configuring the web server to provide the content type is recommended.")),t}},{suffixContentTypeMap:{css:"text/css",epub:"application/epub+zip",gif:"image/gif",html:"text/html",jpg:"image/jpeg",jpeg:"image/jpeg",ncx:"application/x-dtbncx+xml",opf:"application/oebps-package+xml",png:"image/png",svg:"image/svg+xml",xhtml:"application/xhtml+xml"}});return s}),n("models/plain_fetcher",["require","module","jquery","URIjs/URI","./fetch_base"],function(e,t,n,r,i){console.log("plain_fetcher module id: "+t.id);var s=i.extend({initialize:function(e){},isExploded:function(){return!0},resolveURI:function(e){var t=new r(e),n=t.absoluteTo(this.get("baseUrl"));return n.toString()},fetchFileContentsText:function(e,t,r){var i=this;if(typeof e=="undefined")throw"Fetched file URL is undefined!";n.ajax({url:e,dataType:"text",success:function(e){t(e)},error:function(e,t,n){console.log("Error when AJAX fetching "+fullUrl),console.log(t),console.log(n),r(n)}})},relativeToPackageFetchFileContents:function(e,t,n,r){this.fetchFileContentsText(e,n,r)},getPackageDom:function(e){console.log("getting package DOM");var t=this,n=t.get("baseUrl");console.log("baseUrl: "+n),t.fetchFileContentsText(n,function(n){var r=t.parseXml(n);e(r)},this._handleError)}});return s}),n("models/zip_fetcher",["require","module","jquery","URIjs/URI","./fetch_base"],function(e,t,n,r,i){console.log("zip_fetcher module id: "+t.id);var s=i.extend({defaults:{checkCrc32:!1},initialize:function(e){},_withZipFsPerform:function(e,t){var n=this;if(n.has("_zipFs")){var r=n.get("_zipFs");e(r)}else{var i=n.get("baseUrl"),s=n.get("libDir");console.log("zip.workerScriptsPath = "+s),zip.workerScriptsPath=s;var r=new zip.fs.FS;r.importHttpContent(i,!0,function(){n.set("_zipFs",r),e(r)},t)}},_identifyContentTypeFromFileName:function(e){return this.get("_contentTypeDiscovery").identifyContentTypeFromFileName(e)},isExploded:function(){return!1},resolveURI:function(e){return e},fetchFileContents:function(e,t,n){var r=this;if(typeof e=="undefined")throw"Fetched file relative path is undefined!";this._withZipFsPerform(function(i){var s=i.find(e);typeof s=="undefined"||s===null?n(new Error("Entry "+e+" not found in zip "+r.get("baseUrl"))):s.directory?n(new Error("Entry "+e+" is a directory while a file has been expected")):t(s)},r._handleError)},fetchFileContentsText:function(e,t,n){var r=this;r.fetchFileContents(e,function(e){e.getText(t,undefined,r.get("checkCrc32"))},n)},fetchFileContentsData64Uri:function(e,t,n){var r=this;r.fetchFileContents(e,function(n){n.getData64URI(r._identifyContentTypeFromFileName(e),t,undefined,r.get("checkCrc32"))},n)},fetchFileContentsBlob:function(e,t,n){var r=this;r.fetchFileContents(e,function(n){n.getBlob(r._identifyContentTypeFromFileName(e),t,undefined,r.get("checkCrc32"))},n)},relativeToPackageFetchFileContents:function(e,t,n,i){var s=this,o=s.get("_packageFullPath");console.log("Have got _packageFullPath "+o),console.log("packageFullPath: "+o),console.log("relativePath: "+e);var u=decodeURIComponent((new r(e)).absoluteTo(o).toString());console.log("pathRelativeToPackage: "+u);var a=s.fetchFileContentsText;t==="blob"?a=s.fetchFileContentsBlob:t==="data64uri"&&(a=s.fetchFileContentsData64Uri),a.call(s,u,n,i)},getFileContentsFromPackage:function(e,t){var n=this;n.fetchFileContentsText(e,function(e){t(e)},n._handleError)},getContainerXml:function(e){var t="META-INF/container.xml";this.getFileContentsFromPackage(t,e)},getXmlFileDom:function(e,t){var n=this;n.getFileContentsFromPackage(e,function(e){var r=n.parseXml(e);t(r)})},getPackageFullPath:function(e){var t=this;t.getXmlFileDom("META-INF/container.xml",function(n){t.getRootFile(n,e)})},getRootFile:function(e,t){var r=n("rootfile",e),i=r.attr("full-path");console.log("packageFullPath: "+i),t(i)},getPackageDom:function(e){var t=this;t.has("_packageDom")?e(t.get("_packageDom")):t.has("_packageDomInitializationSubscription")?t.get("_packageDomInitializationSubscription").push(e):(t.set("_packageDomInitializationSubscription",[e]),t.getPackageFullPath(function(e){t.set("_packageFullPath",e),console.log("Have set _packageFullPath"+e),t.getXmlFileDom(e,function(e){t.set("_packageDom",e);var n=t.get("_packageDomInitializationSubscription");t.unset("_packageDomInitializationSubscription"),n.forEach(function(t){t(e)})})}))}});return s}),n("models/resource_resolver",["require","module","jquery","URIjs/URI","./fetch_base"],function(e,t,n,r,i){console.log("resource_resolver module id: "+t.id);var s=i.extend({initialize:function(e){},_resolveResourceElements:function(e,t,i,s,o,u){var a=this,f=a.get("_resourceFetcher"),l=n(e+"["+t+"]",i);l.each(function(e,i){var a=n(i).attr(t),l=new r(a);if(l.scheme()===""){var c=n.Deferred();o.push(c);var h=l.absoluteTo(s).toString();f.relativeToPackageFetchFileContents(h,"blob",function(e){n(i).attr(t,window.URL.createObjectURL(e)),c.resolve()},u)}})},resolveInternalPackageResources:function(e,t,r,i,s){var o=this,u=this.parseMarkup(r,t),a=[];o._resolveResourceElements("img","src",u,e,a,s),o._resolveResourceElements("link","href",u,e,a,s),n.when.apply(n,a).done(function(){i(u)})}});return s}),n("models/package_fetcher",["require","module","./fetch_base","./discover_content_type","./plain_fetcher","./zip_fetcher","./resource_resolver"],function(e,t,n,r,i,s,o){console.log("package_fetcher module id: "+t.id);var u=n.extend({initialize:function(e){var t=new r({contentUrl:this.get("packageDocumentURL")});this.set("_contentTypeDiscovery",t),this._setupPackageContentType(),this._setupResourceFetcher()},_setupPackageContentType:function(){this.set("_packageContentType",this.get("_contentTypeDiscovery").identifyContentType())},_getPackageReadStrategy:function(){var e="exploded",t=this.getPackageContentType();return t in this.constructor.contentTypePackageReadStrategyMap&&(e=this.constructor.contentTypePackageReadStrategyMap[t]),e},_setupResourceFetcher:function(){var e=this,t=e._getPackageReadStrategy();if(t==="exploded")console.log("using new PlainExplodedFetcher"),e.set("_resourceFetcher",new i({baseUrl:e.get("packageDocumentURL"),_contentTypeDiscovery:e.get("_contentTypeDiscovery")}));else{if(t!=="zipped")throw new Error("Unsupported package read strategy: "+t);console.log("using new ZipFetcher"),e.set("_resourceFetcher",new s({baseUrl:e.get("packageDocumentURL"),_contentTypeDiscovery:e.get("_contentTypeDiscovery"),libDir:e.get("libDir")}))}e.set("_resourceResolver",new o({_resourceFetcher:e.get("_resourceFetcher")}))},isPackageExploded:function(){return this.get("_resourceFetcher").isExploded()},resolveURI:function(e){return this.get("_resourceFetcher").resolveURI(e)},relativeToPackageFetchFileContents:function(e,t,n,r){this.get("_resourceFetcher").relativeToPackageFetchFileContents(e,t,n,r)},getPackageContentType:function(){return this.get("_packageContentType")},getPackageDom:function(e){this.get("_resourceFetcher").getPackageDom(e)},resolveInternalPackageResources:function(e,t,n,r,i){this.get("_resourceResolver").resolveInternalPackageResources(e,t,n,r,i)}},{contentTypePackageReadStrategyMap:{"application/oebps-package+xml":"exploded","application/epub+zip":"zipped","application/zip":"zipped"}});return u}),n("epub_fetch_module",["require","module","jquery","underscore","backbone","./models/package_fetcher"],function(e,t,n,r,i,s){console.log("epub_fetch_module module id: "+t.id),console.log(t.id+"Backbone:"+i);var o=i.Model.extend({initialize:function(e){this.set("packageFetcher",new s({packageDocumentURL:this.get("packageDocumentURL"),libDir:this.get("libDir")}))},getPackageContentType:function(){return this.get("packageFetcher").getPackageContentType()},getPackageDom:function(e){this.get("packageFetcher").getPackageDom(e)},getPackageDocumentURL:function(e){return this.get("packageDocumentURL")},isPackageExploded:function(){return this.get("packageFetcher").isPackageExploded()},resolveURI:function(e){return this.get("packageFetcher").resolveURI(e)},relativeToPackageFetchFileContents:function(e,t,n,r){this.get("packageFetcher").relativeToPackageFetchFileContents(e,t,n,r)},resolveInternalPackageResources:function(e,t,n,r,i){this.get("packageFetcher").resolveInternalPackageResources(e,t,n,r,i)}});return o}),n("models/manifest_item",["require","module","jquery","underscore","backbone"],function(e,t,n,r,i){var s=i.Model.extend({isSvg:function(){return this.get("media_type")==="image/svg+xml"},isImage:function(){var e=this.get("media_type");return e&&e.indexOf("image/")>-1?e!=="image/svg+xml":!1}});return s}),n("models/manifest",["require","module","jquery","underscore","backbone","./manifest_item"],function(e,t,n,r,i,s){console.log("manifest module id: "+t.id);var o=i.Collection.extend({model:s});return o}),n("models/spine_item",["require","module","jquery","underscore","backbone","./manifest_item"],function(e,t,n,r,i,s){var o=s.extend({defaults:{pageSpreadClass:""},initialize:function(){},isFixedLayout:function(){return this.isSvg()||this.isImage()?!0:typeof this.get("fixed_flow")!="undefined"?this.get("fixed_flow"):!1},firstPageOffset:function(){var e=!this.isFixedLayout(),t=this.get("page_prog_dir")==="rtl"?!0:!1,n=this.get("page_spread")==="left"?!0:!1,r=this.get("page_spread")==="right"?!0:!1;r&&n&&(r=!1,n=!1);if(e)if(t){if(n)return!0}else if(r)return!0;return!1}});return o}),n("models/spine",["require","module","jquery","underscore","backbone","./spine_item"],function(e,t,n,r,i,s){var o=i.Collection.extend({model:s});return o}),n("models/metadata",["require","module","jquery","underscore","backbone"],function(e,t,n,r,i){var s=i.Model.extend({});return s}),n("models/page_spread_property",["require","module","jquery","underscore","backbone"],function(e,t,n,r,i){var s=i.Model.extend({initialize:function(){this.CENTER_PAGE="center_page",this.LEFT_PAGE="left_page",this.RIGHT_PAGE="right_page"},inferiBooksPageSpread:function(e,t){var n=e+1;return n===1?this.CENTER_PAGE:n%2===0&&n===t?this.CENTER_PAGE:n%2===1?this.RIGHT_PAGE:this.LEFT_PAGE},getPageSpreadFromProperties:function(e){return e==="left"?this.LEFT_PAGE:e==="right"?this.RIGHT_PAGE:e==="center"?this.CENTER_PAGE:""},inferUnassignedPageSpread:function(e,t,n){var r,i;if(t.at(e).get("page_spread")==="left"||t.at(e).get("page_spread")==="right"||t.at(e).get("page_spread")==="center")return this.getPageSpreadFromProperties(t.at(e).get("page_spread"));if(e===0)return n==="rtl"?this.RIGHT_PAGE:this.LEFT_PAGE;for(var s=e-1;s>=0;s--)if(s===0||t.at(s).get("page_spread"))return r=this.lastSpecifiedPageSpread(t.at(s).get("page_spread"),n),i=e-s,i%2===0?r==="left"?this.LEFT_PAGE:r==="right"?this.RIGHT_PAGE:n==="rtl"?this.LEFT_PAGE:this.RIGHT_PAGE:r==="left"?this.RIGHT_PAGE:r==="right"?this.LEFT_PAGE:n==="rtl"?this.RIGHT_PAGE:this.LEFT_PAGE},lastSpecifiedPageSpread:function(e,t){return e&&e!==""?e:t==="rtl"?"right":"left"}});return s}),n("models/package_document_parser",["require","module","jquery","underscore","backbone"],function(e,t,n,r,i){console.log("package_document_parser module id: "+t.id);var s=i.Model.extend({initialize:function(e,t){var r=this,i=r.get("epubFetch"),s=n.Deferred();r.set("deferredXmlDom",s),i.getPackageDom(function(e){r.set("xmlDom",e),s.resolve(e)})},parse:function(e){var t=this,n=t.get("deferredXmlDom");n.done(function(n){var r,i,s;r={},r.metadata=t.getJsonMetadata(n),r.bindings=t.getJsonBindings(n),r.spine=t.getJsonSpine(n),r.manifest=t.getJsonManifest(n),r.paginate_backwards=t.paginateBackwards(n),s=t.getCoverHref(n),s&&(r.metadata.cover_href=s),r.metadata.layout==="pre-paginated"&&(r.metadata.fixed_layout=!0),r.spine=t.parseSpineProperties(r.spine),e(r)})},getJsonSpine:function(){var e=this,t,r=[],i=e.get("xmlDom");return t=n("spine",i).children(),n.each(t,function(e,t){var i=n(t),s={idref:i.attr("idref")?i.attr("idref"):"",linear:i.attr("linear")?i.attr("linear"):"",properties:i.attr("properties")?i.attr("properties"):""};r.push(s)}),r},getJsonMetadata:function(){var e=this,t=e.get("xmlDom"),r=n("metadata",t),i={};return i.active_class=n("meta[property='media:active-class']",r).text(),i.author=n("creator",r).text(),i.description=n("description",r).text(),i.epub_version=n("package",t).attr("version")?n("package",t).attr("version"):"",i.id=n("identifier",r).text(),i.language=n("language",r).text(),i.layout=n("meta[property='rendition:layout']",r).text(),i.modified_date=n("meta[property='dcterms:modified']",r).text(),i.ncx=n("spine",t).attr("toc")?n("spine",t).attr("toc"):"",i.orientation=n("meta[property='rendition:orientation']",r).text(),i.page_prog_dir=n("spine",t).attr("page-progression-direction")?n("spine",t).attr("page-progression-direction"):"",i.pubdate=n("date",r).text(),i.publisher=n("publisher",r).text(),i.rights=n("rights").text(),i.spread=n("meta[property='rendition:spread']",r).text(),i.title=n("title",r).text(),i},getJsonManifest:function(){var e=this,t=e.get("epubFetch"),r=e.get("xmlDom"),i=n("manifest",r).children(),s=[];return n.each(i,function(e,t){var r=n(t),i=r.attr("href")?r.attr("href"):"",o={contentDocumentURI:i,href:i,id:r.attr("id")?r.attr("id"):"",media_overlay:r.attr("media-overlay")?r.attr("media-overlay"):"",media_type:r.attr("media-type")?r.attr("media-type"):"",properties:r.attr("properties")?r.attr("properties"):""};console.log("pushing manifest item to JSON manifest. currManifestElementHref: ["+i+"], manifestItem.contentDocumentURI: ["+o.contentDocumentURI+"], manifestItem.media_type: ["+o.media_type+"], manifestItem:"),console.log(o),s.push(o)}),s},getJsonBindings:function(){var e=this.get("xmlDom"),t=n("bindings",e).children(),r=[];return n.each(t,function(e,t){var i=n(t),s={handler:i.attr("handler")?i.attr("handler"):"",media_type:i.attr("media-type")?i.attr("media-type"):""};r.push(s)}),r},getCoverHref:function(){var e=this.get("xmlDom"),t,r;t=e.getElementsByTagName("manifest")[0],r=n('item[properties~="cover-image"]',t);if(r.length===1&&r.attr("href"))return r.attr("href");var i=n('meta[name="cover"]',e),s=i.attr("content");if(i.length===1&&s){r=n('item[id="'+s+'"]',t);if(r.length===1&&r.attr("href"))return r.attr("href")}return r=n("#cover",t),r.length===1&&r.attr("href")?r.attr("href"):null},parseSpineProperties:function(e){var t=function(e){var t={},n=e.split(" ");for(var r=0;r<n.length;r++)n[r]==="rendition:page-spread-center"&&(t.page_spread="center"),n[r]==="page-spread-left"&&(t.page_spread="left"),n[r]==="page-spread-right"&&(t.page_spread="right"),n[r]==="page-spread-right"&&(t.page_spread="right"),n[r]==="rendition:layout-reflowable"&&(t.fixed_flow=!1),n[r]==="rendition:layout-pre-paginated"&&(t.fixed_flow=!0);return t};for(var n=0;n<e.length;n++){var i=t(e[n].properties);r.extend(e[n],i)}return e},paginateBackwards:function(){var e=this.get("xmlDom");return n("spine",e).attr("page-progression-direction")==="rtl"}});return s}),n("models/package_document",["require","module","jquery","underscore","backbone","URIjs/URI","./manifest","./spine","./metadata","./page_spread_property","./package_document_parser"],function(e,t,n,r,i,s,o,u,a,f,l){console.log("package_document module id: "+t.id);var c=i.Model.extend({initialize:function(e,t){var n=this,r=new l({epubFetch:this.get("epubFetch")});r.parse(function(e){n.manifest=new o(e.manifest),n.spine=new u(e.spine),n.metadata=new a(e.metadata),n.bindings=new u(e.bindings),n.pageSpreadProperty=new f,n.isFixedLayout()&&n.assignPageSpreadClass(),n.get("onParsedCallback")()})},getPackageData:function(){var e=this,t=[],n=this.get("epubFetch").get("packageDocumentURL"),r=n.substr(0,n.lastIndexOf("/"));return this.spine.each(function(n){t.push(e.generatePackageData(n))}),{rootUrl:r,rendition_layout:this.isFixedLayout(),spine:{direction:this.pageProgressionDirection(),items:t}}},isFixedLayout:function(){return this.metadata.get("fixed_layout")?!0:!1},getManifestItemById:function(e){var t=this.manifest.find(function(t){if(t.get("id")===e)return t});return t?t.toJSON():undefined},getManifestItemByIdref:function(e){var t=this.getManifestItemById(e);return t?t:undefined},getSpineItemByIdref:function(e){var t=this.getSpineModelByIdref(e);return t?t.toJSON():undefined},getSpineItem:function(e){var t=this.spine.at(e);return t?t.toJSON():undefined},spineLength:function(){return this.spine.length},getNextLinearSpinePosition:function(e){var t=this.spine;if(e===undefined||e<0){e=0;if(t.at(e).get("linear")!=="no")return e}while(e<this.spineLength()-1){e+=1;if(t.at(e).get("linear")!=="no")return e}return undefined},getPrevLinearSpinePosition:function(e){var t=this.spine;if(e===undefined||e>this.spineLength()-1){e=this.spineLength()-1;if(t.at(e).get("linear")!=="no")return e}while(e>0){e-=1;if(t.at(e).get("linear")!=="no")return e}return undefined},hasNextSection:function(e){return e>=0&&e<=this.spineLength()-1?this.getNextLinearSpinePosition(e)>-1:!1},hasPrevSection:function(e){return e>=0&&e<=this.spineLength()-1?this.getPrevLinearSpinePosition(e)>-1:!1},pageProgressionDirection:function(){return this.metadata.get("page_prog_dir")==="rtl"?"rtl":this.metadata.get("page_prog_dir")==="default"?"default":"ltr"},getSpineIndexByHref:function(e){var t=this.getSpineModelFromHref(e);return this.getSpineIndex(t)},getBindingByHandler:function(e){var t=this.bindings.find(function(t){if(t.get("handler")===e)return t});return t?t.toJSON():undefined},generatePackageData:function(e){var t="reflowable",n=this.getManifestModelByIdref(e.get("idref")),r;if(e.isFixedLayout()||this.isFixedLayout())isFixedLayout=!0,t="pre-paginated";r=e.get("page_spread"),r==="left"?r="page-spread-left":r==="right"?r="page-spread-right":r==="center"&&(r="page-spread-center");var i={href:n.get("contentDocumentURI"),media_type:n.get("media_type"),media_overlay:n.get("media_overlay"),idref:e.get("idref"),page_spread:r,rendition_layout:t};return i},getPackageDocumentDOM:function(e){this.get("epubFetch").getPackageDom(e)},getToc:function(){var e=this.getTocItem();if(e){var t=e.get("contentDocumentURI");return t}return null},getTocText:function(e){var t=this.getToc();console.log("tocUrl: ["+t+"]"),this.get("epubFetch").relativeToPackageFetchFileContents(t,"text",function(t){e(t)},function(t){console.error("ERROR fetching TOC from ["+this.getToc()+"]:"),console.error(t),e(undefined)})},getTocDom:function(e){this.getTocText(function(t){if(typeof t=="string"){var n=(new DOMParser).parseFromString(t,"text/xml");e(n)}else e(undefined)})},generateTocListDOM:function(e){var t=this;t.getTocDom(function(r){if(r)if(t.tocIsNcx()){var i;i=t.getNcxOrderedList(n("navMap",r)),e(i[0])}else{var o=t.get("epubFetch").getPackageDocumentURL(),u=(new s(o)).absoluteTo(document.URL),a=(new s(t.getToc())).absoluteTo(document.URL),f=n(r).remove("base"),l=n("<base></base>");n(l).attr("href",a),n(r).find("head").append(l),e(r)}else e(undefined)})},tocIsNcx:function(){var e=this.getTocItem(),t=e.get("contentDocumentURI"),n=t.substr(t.lastIndexOf(".")+1);return n.trim().toLowerCase()==="ncx"?!0:!1},getNcxOrderedList:function(e){var t=this,r=n("<ol></ol>");return n.each(e.children("navPoint"),function(e,i){t.addNavPointElements(n(i),r)}),r},addNavPointElements:function(e,t){var r=this,i=e.children("navLabel").text().trim(),s=e.children("content").attr("src"),o=n("<li class='nav-elem'><a href='"+s+"'>'"+i+"'</a></li>");t.append(o);if(e.children("navPoint").length>0){var u=n("<li></li>"),a=n("<ol></ol>");n.each(e.children("navPoint"),function(e,t){a.append(r.addNavPointElements(n(t),a))}),u.append(a),t.append(u)}},getSpineModelFromHref:function(e){var t=this,n=new s(e),r=n.filename(),i;return this.manifest.each(function(e){var n=new s(e.get("href")),o=n.filename();o===r&&(i=t.getSpineModelByIdref(e.get("id")))}),i},getSpineModelByIdref:function(e){var t=this.spine.find(function(t){if(t.get("idref")===e)return t});return t},getManifestModelByIdref:function(e){var t=this.manifest.find(function(t){if(t.get("id")===e)return t});return t},getSpineIndex:function(e){return this.spine.indexOf(e)},assignPageSpreadClass:function(){var e=this,t,n;this.metadata.get("apple_fixed")?(n=this.spine.length,this.spine.each(function(r,i){t=e.pageSpreadProperty.inferiBooksPageSpread(i,n),r.set({pageSpreadClass:t})})):this.spine.each(function(n,r){n.get("page_spread")?(t=e.pageSpreadProperty.getPageSpreadFromProperties(n.get("page_spread")),n.set({pageSpreadClass:t})):(t=e.pageSpreadProperty.inferUnassignedPageSpread(r,e.spine,e.pageProgressionDirection()),n.set({pageSpreadClass:t}))})},getTocItem:function(){var e=this.manifest,t=this.metadata,n=this.metadata.get("ncx"),r=e.find(function(e){return e.get("properties").indexOf("nav")!==-1?!0:!1});return r?r:n&&n.length>0?e.find(function(e){return e.get("id")===n}):null}});return c}),n("epub_module",["require","module","jquery","underscore","backbone","./models/package_document"],function(e,t,n,r,i,s){var o=function(e,t){var n=new s({epubFetch:e,onParsedCallback:t});return{getPackageData:function(){return n.getPackageData()},isFixedLayout:function(){return n.isFixedLayout()},getManifestItemById:function(e){return n.getManifestItemById(e)},getManifestItemByIdref:function(e){return n.getManifestItemByIdref(e)},getSpineItemByIdref:function(e){return n.getSpineItemByIdref(e)},getSpineItemByIndex:function(e){return n.getSpineItem(e)},spineLength:function(){return n.spineLength()},getNextLinearSpinePosition:function(e){return n.getNextLinearSpinePosition(e)},getPrevLinearSpinePosition:function(e){return n.getPrevLinearSpinePosition(e)},hasNextSection:function(e){return n.hasNextSection(e)},hasPrevSection:function(e){return n.hasPrevSection(e)},pageProgressionDirection:function(){return n.pageProgressionDirection()},getSpineIndexByHref:function(e){return n.getSpineIndexByHref(e)},getTocURL:function(){return n.getToc()},getTocText:function(e){return n.getTocText(e)},getTocDom:function(e){return n.getTocDom(e)},generateTocListDOM:function(e){return n.generateTocListDOM(e)},tocIsNcx:function(){return n.tocIsNcx()}}};return o}),n("epub_reading_system",["require","module"],function(e,t){return navigator.epubReadingSystem={name:"Readium.js",version:"0.0.1",layoutStyle:"paginated",hasFeature:function(e,t){return t&&t!=="1.0"?!1:e==="dom-manipulation"?!0:e==="layout-changes"?!0:e==="touch-events"?!1:e==="mouse-events"?!0:e==="keyboard-events"?!0:e==="spine-scripting"?!0:!1}},navigator.epubReadingSystem}),n("epub_renderer_module",["require","module","jquery","underscore","backbone"],function(e,t,r,i,s){ReadiumSDK={version:function(){return"0.5.1"},Models:{},Views:{},Collections:{},Routers:{},Helpers:{}},i.extend(ReadiumSDK,s.Events),n("readiumSDK",function(){}),ReadiumSDK.Helpers.Rect=function(e,t,n,r){this.left=e,this.top=t,this.width=n,this.height=r,this.right=function(){return this.left+this.width},this.bottom=function(){return this.top+this.height},this.isOverlap=function(e,t){return t==undefined&&(t=0),!(e.right()<this.left+t||e.left>this.right()-t||e.bottom()<this.top+t||e.top>this.bottom()-t)}},ReadiumSDK.Helpers.Rect.fromElement=function(e){var t=e[0],n=t.offsetLeft,r=t.offsetTop,i=t.offsetWidth,s=t.offsetHeight;while(t=t.offsetParent)n+=t.offsetLeft,r+=t.offsetTop;return new ReadiumSDK.Helpers.Rect(n,r,i,s)},ReadiumSDK.Helpers.LoadIframe=function(e,t,n,r){var i=!0;e.onload=function(){i=!1,n.call(r,!0)},window.setTimeout(function(){i&&(i=!1,n.call(r,!1))},500),e.src=t},ReadiumSDK.Helpers.ResolveContentRef=function(e,t){if(!t)return e;var n=t.split("/");n.pop();var r=e.split("/");while(n.length>0&&r[0]==="..")n.pop(),r.splice(0,1);var i=n.concat(r);return i.join("/")},ReadiumSDK.Helpers.EndsWith=function(e,t){return e.indexOf(t,e.length-t.length)!==-1},n("helpers",function(){}),ReadiumSDK.Models.Trigger=function(e){var t=r(e);this.action=t.attr("action"),this.ref=t.attr("ref"),this.event=t.attr("ev:event"),this.observer=t.attr("ev:observer"),this.ref=t.attr("ref")},ReadiumSDK.Models.Trigger.prototype.subscribe=function(e){var t="#"+this.observer,n=this;r(t,e).on(this.event,function(){n.execute(e)})},ReadiumSDK.Models.Trigger.prototype.execute=function(e){var t=r("#"+this.ref,e);switch(this.action){case"show":t.css("visibility","visible");break;case"hide":t.css("visibility","hidden");break;case"play":t[0].currentTime=0,t[0].play();break;case"pause":t[0].pause();break;case"resume":t[0].play();break;case"mute":t[0].muted=!0;break;case"unmute":t[0].muted=!1;break;default:console.log("do not no how to handle trigger "+this.action)}},n("triggers",function(){}),ReadiumSDK.Models.BookmarkData=function(e,t){this.idref=e,this.contentCFI=t},n("bookmarkData",function(){}),ReadiumSDK.Models.SpineItem=function(e,t,n){this.idref=e.idref,this.href=e.href,this.page_spread=e.page_spread,this.rendition_layout=e.rendition_layout,this.index=t,this.spine=n,this.isLeftPage=function(){return this.page_spread==="page-spread-left"},this.isRightPage=function(){return this.page_spread==="page-spread-right"},this.isCenterPage=function(){return!this.isLeftPage()&&!this.isRightPage()},this.isReflowable=function(){return!this.isFixedLayout()},this.isFixedLayout=function(){return this.rendition_layout?this.rendition_layout==="pre-paginated":this.spine.package.isFixedLayout()}},n("spineItem",function(){}),ReadiumSDK.Models.Spine=s.Model.extend({items:[],direction:undefined,"package":undefined,initialize:function(){this.reset(),this.package=this.get("package");var e=this.get("spineData");if(e){this.direction=e.direction,this.direction||(this.direction="ltr");var t=e.items.length;for(var n=0;n<t;n++){var r=new ReadiumSDK.Models.SpineItem(e.items[n],n,this);this.items.push(r)}}},reset:function(){this.items=[],this.direction=undefined,this.package=undefined},prevItem:function(e){return this.isValidIndex(e.index-1)?this.items[e.index-1]:undefined},nextItem:function(e){return this.isValidIndex(e.index+1)?this.items[e.index+1]:undefined},getItemUrl:function(e){return this.package.rootUrl?ReadiumSDK.Helpers.EndsWith(this.package.rootUrl,"/")?this.package.rootUrl+e.href:this.package.rootUrl+"/"+e.href:e.href},isValidIndex:function(e){return e>=0&&e<this.items.length},first:function(){return this.items[0]},last:function(){return this.items[this.items.length-1]},item:function(e){return this.item(e)},isRightToLeft:function(){return this.direction=="rtl"},isLeftToRight:function(){return!this.isRightToLeft()},getItemById:function(e){var t=this.items.length;for(var n=0;n<t;n++)if(this.items[n].idref==e)return this.items[n];return undefined},getItemByHref:function(e){var t=this.items.length;for(var n=0;n<t;n++)if(this.items[n].href==e)return this.items[n];return undefined}}),n("spine",function(){}),ReadiumSDK.Models.Spread=function(e){this.spine=e,this.leftItem=undefined,this.rightItem=undefined,this.centerItem=undefined,this.isSyntheticSpread=!0,this.setSyntheticSpread=function(e){this.isSyntheticSpread=e},this.openFirst=function(){this.spine.items.length==0?this.resetItems():this.openItem(this.spine.first())},this.openLast=function(){this.spine.items.length==0?this.resetItems():this.openItem(this.spine.last())},this.openItem=function(e){this.resetItems(),this.setItem(e);var t=this.getNeighbourItem(e);t&&this.setItem(t)},this.resetItems=function(){this.leftItem=undefined,this.rightItem=undefined,this.centerItem=undefined},this.setItem=function(e){if(!this.isSyntheticSpread){this.centerItem=e;return}e.isLeftPage()?this.leftItem=e:e.isRightPage()?this.rightItem=e:this.centerItem=e},this.openNext=function(){var e=this.validItems();if(e.length==0)this.openFirst();else{var t=this.spine.nextItem(e[e.length-1]);t&&this.openItem(t)}},this.openPrev=function(){var e=this.validItems();if(e.length==0)this.openLast();else{var t=this.spine.prevItem(e[0]);t&&this.openItem(t)}},this.validItems=function(){var e=[];return this.leftItem&&e.push(this.leftItem),this.rightItem&&e.push(this.rightItem),this.centerItem&&e.push(this.centerItem),e.sort(function(e,t){return e.index-t.index}),e},this.getNeighbourItem=function(e){var t=undefined;return this.isSyntheticSpread?(e.isLeftPage()?t=this.spine.isRightToLeft()?this.spine.prevItem(e):this.spine.nextItem(e):e.isRightPage()&&(t=this.spine.isRightToLeft()?this.spine.nextItem(e):this.spine.prevItem(e)),t&&(t.isCenterPage()||t.page_spread===e.page_spread)&&(t=undefined),t):t}},n("fixedPageSpread",function(){}),ReadiumSDK.Models.Package=s.Model.extend({spine:undefined,rendition_layout:undefined,rootUrl:undefined,initialize:function(){this.reset();var e=this.get("packageData");e&&(this.rootUrl=e.rootUrl,this.rendition_layout=e.rendition_layout,this.rendition_layout||(this.rendition_layout="reflowable"),this.spine=new ReadiumSDK.Models.Spine({spineData:e.spine,"package":this}))},reset:function(){this.spine=undefined,this.rendition_layout=undefined,this.rootUrl=undefined},isFixedLayout:function(){return this.rendition_layout==="pre-paginated"},isReflowable:function(){return!this.isFixedLayout()}}),n("package",function(){}),ReadiumSDK.Models.ViewerSettings=function(e){this.isSyntheticSpread=!0,this.fontSize=100,this.columnGap=20,this.update=function(e){e.isSyntheticSpread!==undefined&&(this.isSyntheticSpread=e.isSyntheticSpread),e.columnGap!==undefined&&(this.columnGap=e.columnGap),e.fontSize!==undefined&&(this.fontSize=e.fontSize)},this.update(e)},n("viewerSettings",function(){}),ReadiumSDK.Models.CurrentPagesInfo=function(e,t,n){this.pageProgressionDirection=n,this.isFixedLayout=t,this.spineItemCount=e,this.openPages=[],this.addOpenPage=function(e,t,n,r){this.openPages.push({spineItemPageIndex:e,spineItemPageCount:t,idref:n,spineItemIndex:r}),this.sort()},this.sort=function(){this.openPages.sort(function(e,t){return e.spineItemIndex!=t.spineItemIndex?e.spineItemIndex-t.spineItemIndex:e.pageIndex-t.pageIndex})}},n("currentPagesInfo",function(){}),ReadiumSDK.Models.PageOpenRequest=function(e){this.spineItem=e,this.spineItemPageIndex=undefined,this.elementId=undefined,this.elementCfi=undefined,this.firstPage=!1,this.lastPage=!1,this.reset=function(){this.spineItemPageIndex=undefined,this.elementId=undefined,this.elementCfi=undefined,this.firstPage=!1,this.lastPage=!1},this.setFirstPage=function(){this.reset(),this.firstPage=!0},this.setLastPage=function(){this.reset(),this.lastPage=!0},this.setPageIndex=function(e){this.reset(),this.spineItemPageIndex=e},this.setElementId=function(e){this.reset(),this.elementId=e},this.setElementCfi=function(e){this.reset(),this.elementCfi=e}},n("pageOpenRequest",function(){}),function(e){var t={};t.Parser=function(){function e(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var t={parse:function(t,n){function a(e,t,n){var r=e,i=n-e.length;for(var s=0;s<i;s++)r=t+r;return r}function f(e){var t=e.charCodeAt(0),n,r;return t<=255?(n="x",r=2):(n="u",r=4),"\\"+n+a(t.toString(16).toUpperCase(),"0",r)}function l(e){if(i<o)return;i>o&&(o=i,u=[]),u.push(e)}function c(){var e,n,r,o,u;return o=i,u=i,t.substr(i,8)==="epubcfi("?(e="epubcfi(",i+=8):(e=null,s===0&&l('"epubcfi("')),e!==null?(n=h(),n!==null?(t.charCodeAt(i)===41?(r=")",i++):(r=null,s===0&&l('")"')),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){return{type:"CFIAST",cfiString:t}}(o,e[1])),e===null&&(i=o),e}function h(){var e,t,n,r;return n=i,r=i,e=d(),e!==null?(t=p(),t!==null?e=[e,t]:(e=null,i=r)):(e=null,i=r),e!==null&&(e=function(e,t,n){return{type:"cfiString",path:t,localPath:n}}(n,e[0],e[1])),e===null&&(i=n),e}function p(){var e,t,n,r;n=i,r=i,t=d(),t===null&&(t=v());if(t!==null){e=[];while(t!==null)e.push(t),t=d(),t===null&&(t=v())}else e=null;return e!==null?(t=m(),t=t!==null?t:"",t!==null?e=[e,t]:(e=null,i=r)):(e=null,i=r),e!==null&&(e=function(e,t,n){return{steps:t,termStep:n}}(n,e[0],e[1])),e===null&&(i=n),e}function d(){var e,n,r,o,u,a,f,c;return a=i,f=i,t.charCodeAt(i)===47?(e="/",i++):(e=null,s===0&&l('"/"')),e!==null?(n=N(),n!==null?(c=i,t.charCodeAt(i)===91?(r="[",i++):(r=null,s===0&&l('"["')),r!==null?(o=g(),o!==null?(t.charCodeAt(i)===93?(u="]",i++):(u=null,s===0&&l('"]"')),u!==null?r=[r,o,u]:(r=null,i=c)):(r=null,i=c)):(r=null,i=c),r=r!==null?r:"",r!==null?e=[e,n,r]:(e=null,i=f)):(e=null,i=f)):(e=null,i=f),e!==null&&(e=function(e,t,n){return{type:"indexStep",stepLength:t,idAssertion:n[1]}}(a,e[1],e[2])),e===null&&(i=a),e}function v(){var e,n,r,o,u,a,f,c;return a=i,f=i,t.substr(i,2)==="!/"?(e="!/",i+=2):(e=null,s===0&&l('"!/"')),e!==null?(n=N(),n!==null?(c=i,t.charCodeAt(i)===91?(r="[",i++):(r=null,s===0&&l('"["')),r!==null?(o=g(),o!==null?(t.charCodeAt(i)===93?(u="]",i++):(u=null,s===0&&l('"]"')),u!==null?r=[r,o,u]:(r=null,i=c)):(r=null,i=c)):(r=null,i=c),r=r!==null?r:"",r!==null?e=[e,n,r]:(e=null,i=f)):(e=null,i=f)):(e=null,i=f),e!==null&&(e=function(e,t,n){return{type:"indirectionStep",stepLength:t,idAssertion:n[1]}}(a,e[1],e[2])),e===null&&(i=a),e}function m(){var e,n,r,o,u,a,f,c;return a=i,f=i,t.charCodeAt(i)===58?(e=":",i++):(e=null,s===0&&l('":"')),e!==null?(n=N(),n!==null?(c=i,t.charCodeAt(i)===91?(r="[",i++):(r=null,s===0&&l('"["')),r!==null?(o=y(),o!==null?(t.charCodeAt(i)===93?(u="]",i++):(u=null,s===0&&l('"]"')),u!==null?r=[r,o,u]:(r=null,i=c)):(r=null,i=c)):(r=null,i=c),r=r!==null?r:"",r!==null?e=[e,n,r]:(e=null,i=f)):(e=null,i=f)):(e=null,i=f),e!==null&&(e=function(e,t,n){return{type:"textTerminus",offsetValue:t,textAssertion:n[1]}}(a,e[1],e[2])),e===null&&(i=a),e}function g(){var e,t;return t=i,e=S(),e!==null&&(e=function(e,t){return t}(t,e)),e===null&&(i=t),e}function y(){var e,t,n,r;return n=i,r=i,e=w(),e=e!==null?e:"",e!==null?(t=b(),t=t!==null?t:"",t!==null?e=[e,t]:(e=null,i=r)):(e=null,i=r),e!==null&&(e=function(e,t,n){return{type:"textLocationAssertion",csv:t,parameter:n}}(n,e[0],e[1])),e===null&&(i=n),e}function b(){var e,n,r,o,u,a;return u=i,a=i,t.charCodeAt(i)===59?(e=";",i++):(e=null,s===0&&l('";"')),e!==null?(n=E(),n!==null?(t.charCodeAt(i)===61?(r="=",i++):(r=null,s===0&&l('"="')),r!==null?(o=E(),o!==null?e=[e,n,r,o]:(e=null,i=a)):(e=null,i=a)):(e=null,i=a)):(e=null,i=a),e!==null&&(e=function(e,t,n){return{type:"parameter",LHSValue:t,RHSValue:n}}(u,e[1],e[3])),e===null&&(i=u),e}function w(){var e,n,r,o,u;return o=i,u=i,e=S(),e=e!==null?e:"",e!==null?(t.charCodeAt(i)===44?(n=",",i++):(n=null,s===0&&l('","')),n!==null?(r=S(),r=r!==null?r:"",r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t,n){return{type:"csv",preAssertion:t,postAssertion:n}}(o,e[0],e[2])),e===null&&(i=o),e}function E(){var e,t,n;n=i,t=x(),t===null&&(t=P());if(t!==null){e=[];while(t!==null)e.push(t),t=x(),t===null&&(t=P())}else e=null;return e!==null&&(e=function(e,t){return t.join("")}(n,e)),e===null&&(i=n),e}function S(){var e,t,n;n=i,t=x(),t===null&&(t=P(),t===null&&(t=C()));if(t!==null){e=[];while(t!==null)e.push(t),t=x(),t===null&&(t=P(),t===null&&(t=C()))}else e=null;return e!==null&&(e=function(e,t){return t.join("")}(n,e)),e===null&&(i=n),e}function x(){var e,t,n,r;return n=i,r=i,e=k(),e!==null?(t=k(),t!==null?e=[e,t]:(e=null,i=r)):(e=null,i=r),e===null&&(r=i,e=k(),e!==null?(t=A(),t!==null?e=[e,t]:(e=null,i=r)):(e=null,i=r),e===null&&(r=i,e=k(),e!==null?(t=O(),t!==null?e=[e,t]:(e=null,i=r)):(e=null,i=r),e===null&&(r=i,e=k(),e!==null?(t=M(),t!==null?e=[e,t]:(e=null,i=r)):(e=null,i=r),e===null&&(r=i,e=k(),e!==null?(t=_(),t!==null?e=[e,t]:(e=null,i=r)):(e=null,i=r),e===null&&(r=i,e=k(),e!==null?(t=D(),t!==null?e=[e,t]:(e=null,i=r)):(e=null,i=r)))))),e!==null&&(e=function(e,t){return t[1]}(n,e)),e===null&&(i=n),e}function T(){var e,n,r,o,u,a,f;u=i,a=i,f=i,/^[1-9]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[1-9]"));if(e!==null){/^[0-9]/.test(t.charAt(i))?(r=t.charAt(i),i++):(r=null,s===0&&l("[0-9]"));if(r!==null){n=[];while(r!==null)n.push(r),/^[0-9]/.test(t.charAt(i))?(r=t.charAt(i),i++):(r=null,s===0&&l("[0-9]"))}else n=null;n!==null?e=[e,n]:(e=null,i=f)}else e=null,i=f;if(e!==null){t.charCodeAt(i)===46?(n=".",i++):(n=null,s===0&&l('"."'));if(n!==null){f=i,r=[],/^[0-9]/.test(t.charAt(i))?(o=t.charAt(i),i++):(o=null,s===0&&l("[0-9]"));while(o!==null)r.push(o),/^[0-9]/.test(t.charAt(i))?(o=t.charAt(i),i++):(o=null,s===0&&l("[0-9]"));r!==null?(/^[1-9]/.test(t.charAt(i))?(o=t.charAt(i),i++):(o=null,s===0&&l("[1-9]")),o!==null?r=[r,o]:(r=null,i=f)):(r=null,i=f),r!==null?e=[e,n,r]:(e=null,i=a)}else e=null,i=a}else e=null,i=a;return e!==null&&(e=function(e,t,n){return t.join("")+"."+n.join("")}(u,e[0],e[2])),e===null&&(i=u),e}function N(){var e,n,r,o,u;o=i,t.charCodeAt(i)===48?(e="0",i++):(e=null,s===0&&l('"0"'));if(e===null){u=i,/^[1-9]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[1-9]"));if(e!==null){n=[],/^[0-9]/.test(t.charAt(i))?(r=t.charAt(i),i++):(r=null,s===0&&l("[0-9]"));while(r!==null)n.push(r),/^[0-9]/.test(t.charAt(i))?(r=t.charAt(i),i++):(r=null,s===0&&l("[0-9]"));n!==null?e=[e,n]:(e=null,i=u)}else e=null,i=u}return e!==null&&(e=function(e,t){return t==="0"?"0":t[0].concat(t[1].join(""))}(o,e)),e===null&&(i=o),e}function C(){var e,n;return n=i,t.charCodeAt(i)===32?(e=" ",i++):(e=null,s===0&&l('" "')),e!==null&&(e=function(e){return" "}(n)),e===null&&(i=n),e}function k(){var e,n;return n=i,t.charCodeAt(i)===94?(e="^",i++):(e=null,s===0&&l('"^"')),e!==null&&(e=function(e){return"^"}(n)),e===null&&(i=n),e}function L(){var e,n;return n=i,t.charCodeAt(i)===34?(e='"',i++):(e=null,s===0&&l('"\\""')),e!==null&&(e=function(e){return'"'}(n)),e===null&&(i=n),e}function A(){var e,n;return n=i,t.charCodeAt(i)===91?(e="[",i++):(e=null,s===0&&l('"["')),e===null&&(t.charCodeAt(i)===93?(e="]",i++):(e=null,s===0&&l('"]"'))),e!==null&&(e=function(e,t){return t}(n,e)),e===null&&(i=n),e}function O(){var e,n;return n=i,t.charCodeAt(i)===40?(e="(",i++):(e=null,s===0&&l('"("')),e===null&&(t.charCodeAt(i)===41?(e=")",i++):(e=null,s===0&&l('")"'))),e!==null&&(e=function(e,t){return t}(n,e)),e===null&&(i=n),e}function M(){var e,n;return n=i,t.charCodeAt(i)===44?(e=",",i++):(e=null,s===0&&l('","')),e!==null&&(e=function(e){return","}(n)),e===null&&(i=n),e}function _(){var e,n;return n=i,t.charCodeAt(i)===59?(e=";",i++):(e=null,s===0&&l('";"')),e!==null&&(e=function(e){return";"}(n)),e===null&&(i=n),e}function D(){var e,n;return n=i,t.charCodeAt(i)===61?(e="=",i++):(e=null,s===0&&l('"="')),e!==null&&(e=function(e){return"="}(n)),e===null&&(i=n),e}function P(){var e,n;return n=i,/^[a-z]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[a-z]")),e===null&&(/^[A-Z]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[A-Z]")),e===null&&(/^[0-9]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[0-9]")),e===null&&(t.charCodeAt(i)===45?(e="-",i++):(e=null,s===0&&l('"-"')),e===null&&(t.charCodeAt(i)===95?(e="_",i++):(e=null,s===0&&l('"_"')))))),e!==null&&(e=function(e,t){return t}(n,e)),e===null&&(i=n),e}function H(e){e.sort();var t=null,n=[];for(var r=0;r<e.length;r++)e[r]!==t&&(n.push(e[r]),t=e[r]);return n}function B(){var e=1,n=1,r=!1;for(var s=0;s<Math.max(i,o);s++){var u=t.charAt(s);u==="\n"?(r||e++,n=1,r=!1):u==="\r"||u==="\u2028"||u==="\u2029"?(e++,n=1,r=!0):(n++,r=!1)}return{line:e,column:n}}var r={fragment:c,path:h,local_path:p,indexStep:d,indirectionStep:v,terminus:m,idAssertion:g,textLocationAssertion:y,parameter:b,csv:w,valueNoSpace:E,value:S,escapedSpecialChars:x,number:T,integer:N,space:C,circumflex:k,doubleQuote:L,squareBracket:A,parentheses:O,comma:M,semicolon:_,equal:D,character:P};if(n!==undefined){if(r[n]===undefined)throw new Error("Invalid rule name: "+e(n)+".")}else n="fragment";var i=0,s=0,o=0,u=[],j=r[n]();if(j===null||i!==t.length){var F=Math.max(i,o),I=F<t.length?t.charAt(F):null,q=B();throw new this.SyntaxError(H(u),I,F,q.line,q.column)}return j},toSource:function(){return this._source}};return t.SyntaxError=function(t,n,r,i,s){function o(t,n){var r,i;switch(t.length){case 0:r="end of input";break;case 1:r=t[0];break;default:r=t.slice(0,t.length-1).join(", ")+" or "+t[t.length-1]}return i=n?e(n):"end of input","Expected "+r+" but "+i+" found."}this.name="SyntaxError",this.expected=t,this.found=n,this.message=o(t,n),this.offset=r,this.line=i,this.column=s},t.SyntaxError.prototype=Error.prototype,t}(),t.CFIInstructions={getNextNode:function(e,t,n,r,i){var s;return e%2==0?s=this.elementNodeStep(e,t,n,r,i):s=this.inferTargetTextNode(e,t,n,r,i),s},followIndirectionStep:function(e,n,i,s,o){var u=this,a,f,l,c;if(n===undefined||!n.is("iframe"))throw t.NodeTypeError(n,"expected an iframe element");if(n.is("iframe"))return a=n.contents(),f=this.applyBlacklist(a.children(),i,s,o),l=r(f[0]),c=this.getNextNode(e,l,i,s,o),c},textTermination:function(e,n,r){if(e===undefined)throw t.NodeTypeError(e,"expected a terminating node, or node list");if(e.length===0)throw t.TerminusError("Text","Text offset:"+n,"no nodes found for termination condition");return e=this.injectCFIMarkerIntoText(e,n,r),e},targetIdMatchesIdAssertion:function(e,t){return e.attr("id")===t?!0:!1},elementNodeStep:function(e,n,i,s,o){var u,a,f,l=e/2-1;a=this.applyBlacklist(n.children(),i,s,o),f=a.length;if(this.indexOutOfRange(l,f))throw t.OutOfRangeError(l,f-1,"");return u=r(a[l]),u},retrieveItemRefHref:function(e,t){return r("#"+e.attr("idref"),t).attr("href")},indexOutOfRange:function(e,t){return e>t-1?!0:!1},injectCFIMarkerIntoText:function(e,n,i){var s,o,u=0,a,f,l,c;for(s=0;s<=e.length;s++)if(e[s].nodeType===3){currNodeMaxIndex=e[s].nodeValue.length-1+u,a=n-u;if(currNodeMaxIndex>=n)return f=e[s].nodeValue,e[s].nodeValue=f.slice(0,a),l=r(i).insertAfter(e.eq(s)),c=r(document.createTextNode(f.slice(a,f.length))),r(c).insertAfter(l),e.parent();u+=currNodeMaxIndex}throw t.TerminusError("Text","Text offset:"+n,"The offset exceeded the length of the text")},inferTargetTextNode:function(e,n,r,i,s){var o,u,a,f,l;o=this.applyBlacklist(n.contents(),r,i,s),a=(parseInt(e)+1)/2,u=1,l=o.filter(function(){return u===a?this.nodeType===3?!0:(u++,!1):(this.nodeType!==3&&this!==o.lastChild&&u++,!1)});if(l.length===0)throw t.OutOfRangeError(a,u-1,"Index out of range");return l},applyBlacklist:function(e,t,n,i){var s;return s=e.filter(function(){var e=r(this),s=!0;return t&&r.each(t,function(t,n){if(e.hasClass(n))return s=!1,!1}),n&&r.each(n,function(t,n){if(e.is(n))return s=!1,!1}),i&&r.each(i,function(t,n){if(e.attr("id")===n)return s=!1,!1}),s}),s}},t.Interpreter={getContentDocHref:function(e,n,i,s,o){var u=r(n),a=decodeURI(e),f=t.Parser.parse(a);if(f===undefined||f.type!=="CFIAST")throw t.NodeTypeError(f,"expected CFI AST root node");var l=r(r("package",u)[0]),c=this.interpretIndexStepNode(f.cfiString.path,l,i,s,o),h=0,p;for(h=0;h<=f.cfiString.localPath.steps.length-1;h++){p=f.cfiString.localPath.steps[h],p.type==="indexStep"?c=this.interpretIndexStepNode(p,c,i,s,o):p.type==="indirectionStep"&&(c=this.interpretIndirectionStepNode(p,c,i,s,o));if(c.is("itemref"))return t.CFIInstructions.retrieveItemRefHref(c,u)}},injectElement:function(e,n,i,s,o,u){var a=decodeURI(e),f=t.Parser.parse(a),l,c;return c=this.getFirstIndirectionStepNum(f),l=f.cfiString.localPath.steps[c],l.type="indexStep",$currElement=this.interpretLocalPath(f.cfiString,c,r("html",n),s,o,u),$currElement=this.interpretTextTerminusNode(f.cfiString.localPath.termStep,$currElement,i),$currElement},getTargetElement:function(e,n,i,s,o){var u=decodeURI(e),a=t.Parser.parse(u),f,l;return l=this.getFirstIndirectionStepNum(a),f=a.cfiString.localPath.steps[l],f.type="indexStep",$currElement=this.interpretLocalPath(a.cfiString,l,r("html",n),i,s,o),$currElement},getTargetElementWithPartialCFI:function(e,n,i,s,o){var u=decodeURI(e),a=t.Parser.parse(u),f,l=this.interpretIndexStepNode(a.cfiString.path,r("html",n),i,s,o);return l=this.interpretLocalPath(a.cfiString,0,l,i,s,o),l},getTextTerminusInfoWithPartialCFI:function(e,n,i,s,o){var u=decodeURI(e),a=t.Parser.parse(u),f,l,c=this.interpretIndexStepNode(a.cfiString.path,r("html",n),i,s,o);return c=this.interpretLocalPath(a.cfiString,0,c,i,s,o),l=parseInt(a.cfiString.localPath.termStep.offsetValue),{textNode:c,textOffset:l}},getFirstIndirectionStepNum:function(e){var t=0;for(t;t<=e.cfiString.localPath.steps.length-1;t++){nextStepNode=e.cfiString.localPath.steps[t];if(nextStepNode.type==="indirectionStep")return t}},interpretLocalPath:function(e,t,n,r,i,s){var o=t,u;for(o;o<=e.localPath.steps.length-1;o++)u=e.localPath.steps[o],u.type==="indexStep"?n=this.interpretIndexStepNode(u,n,r,i,s):u.type==="indirectionStep"&&(n=this.interpretIndirectionStepNode(u,n,r,i,s));return n},interpretIndexStepNode:function(e,n,r,i,s){if(e===undefined||e.type!=="indexStep")throw t.NodeTypeError(e,"expected index step node");var o=t.CFIInstructions.getNextNode(e.stepLength,n,r,i,s);if(e.idAssertion&&!t.CFIInstructions.targetIdMatchesIdAssertion(o,e.idAssertion))throw t.CFIAssertionError(e.idAssertion,o.attr("id"),"Id assertion failed");return o},interpretIndirectionStepNode:function(e,n,r,i,s){if(e===undefined||e.type!=="indirectionStep")throw t.NodeTypeError(e,"expected indirection step node");var o=t.CFIInstructions.followIndirectionStep(e.stepLength,n,r,i);if(e.idAssertion&&!t.CFIInstructions.targetIdMatchesIdAssertion(o,e.idAssertion))throw t.CFIAssertionError(e.idAssertion,o.attr("id"),"Id assertion failed");return o},interpretTextTerminusNode:function(e,n,r){if(e===undefined||e.type!=="textTerminus")throw t.NodeTypeError(e,"expected text terminus node");var i=t.CFIInstructions.textTermination(n,e.offsetValue,r);return i}},t.NodeTypeError=function(e,t){function n(){this.node=e}return n.prototype=new Error(t),n.constructor=n,new n},t.OutOfRangeError=function(e,t,n){function r(){this.targetIndex=e,this.maxIndex=t}return r.prototype=new Error(n),r.constructor=r(),new r},t.TerminusError=function(e,t,n){function r(){this.terminusType=e,this.terminusCondition=t}return r.prototype=new Error(n),r.constructor=r(),new r},t.CFIAssertionError=function(e,t,n){function r(){this.expectedAssertion=e,this.targetElementAssertion=t}return r.prototype=new Error(n),r.constructor=r(),new r},t.Generator={generateCharacterOffsetCFIComponent:function(e,t,n,i,s){var o,u,a,f;return this.validateStartTextNode(e,t),o=this.createCFITextNodeStep(r(e),t,n,i,s),u=this.createCFIElementSteps(r(e).parent(),"html",n,i,s)+o,u.substring(1,u.length)},generateElementCFIComponent:function(e,t,n,i){var s,o,u;return s=this.createCFIElementSteps(r(e),"html",t,n,i),s.substring(1,s.length)},generatePackageDocumentCFIComponent:function(e,t,n,i,s){return this.validateContentDocumentName(e),this.validatePackageDocument(t,e),$itemRefStartNode=r("itemref[idref='"+e+"']",r(t)),packageDocCFIComponent=this.createCFIElementSteps($itemRefStartNode,"package",n,i,s),packageDocCFIComponent+"!"},generateCompleteCFI:function(e,t){return"epubcfi("+e+t+")"},validateStartTextNode:function(e,n){if(!e)throw new t.NodeTypeError(e,"Cannot generate a character offset from a starting point that is not a text node");if(e.nodeType!=3)throw new t.NodeTypeError(e,"Cannot generate a character offset from a starting point that is not a text node");if(n<0)throw new t.OutOfRangeError(n,0,"Character offset cannot be less than 0");if(n>e.nodeValue.length)throw new t.OutOfRangeError(n,e.nodeValue.length-1,"character offset cannot be greater than the length of the text node")},validateContentDocumentName:function(e){if(!e)throw new Error("The idref for the content document, as found in the spine, must be supplied")},validatePackageDocument:function(e,t){if(!e)throw new Error("A package document must be supplied to generate a CFI");if(r(r("itemref[idref='"+t+"']",e)[0]).length===0)throw new Error("The idref of the content document could not be found in the spine")},createCFITextNodeStep:function(e,n,i,s,o){var u,a,f,l,c,h,p,d,v;u=e.parent(),a=t.CFIInstructions.applyBlacklist(u.contents(),i,s,o);var m,g;return r.each(a,function(t){if(this.nodeType===3){if(this===e[0])return m?l=g:l=t,!1;m=!0,g||(g=t)}else m=!1,g=undefined}),f=l*2+1,"/"+f+":"+n},findOriginalTextNodeCharOffset:function(e,n,i,s,o){var u,a,f;u=e.parent(),a=t.CFIInstructions.applyBlacklist(u.contents(),i,s,o);var l,c=-1;return r.each(a,function(t){if(this.nodeType===3){if(this===e[0])return l?c+=n:c=n,!1;c+=this.length,l=!0}else l=!1}),c},createCFIElementSteps:function(e,n,i,s,o){var u,a,f,l,c,h;return u=t.CFIInstructions.applyBlacklist(e.parent().children(),i,s,o),r.each(u,function(t,n){if(this===e[0])return f=t,!1}),l=(f+1)*2,e.attr("id")?h="/"+l+"["+e.attr("id")+"]":h="/"+l,a=e.parent(),a.is(n)||e.is(n)?n==="html"?"!"+h:h:this.createCFIElementSteps(a,n,i,s,o)+h}};if(e.EPUBcfi)throw new Error("The EPUB cfi library has already been defined");e.EPUBcfi=t}(typeof window=="undefined"?this:window),n("epubCfi",function(){}),ReadiumSDK.Views.CfiNavigationLogic=function(e,t){this.$viewport=e,this.$iframe=t,this.getRootElement=function(){return this.$iframe[0].contentDocument.documentElement},this.findFirstVisibleElement=function(e){var t,n=null,i=0;return t=r("body",this.getRootElement()).find(":not(iframe)").contents().filter(function(){return this.nodeType===Node.TEXT_NODE||this.nodeName.toLowerCase()==="img"}),r.each(t,function(){var t;if(this.nodeType===Node.TEXT_NODE){var s=this.nodeValue.replace(/\n/g,"");s=s.replace(/ /g,"");if(!(s.length>0))return!0;t=r(this).parent()}else t=r(this);var o=ReadiumSDK.Helpers.Rect.fromElement(t);return o.bottom()>e?(n=t,o.top>e?i=0:i=Math.ceil((e-o.top)/o.height*100),!1):!0}),{$element:n,percentY:i}},this.getFirstVisibleElementCfi=function(e){var t=this.findFirstVisibleElement(e);if(!t.$element)return console.log("Could not generate CFI no visible element on page"),undefined;var n=EPUBcfi.Generator.generateElementCFIComponent(t.$element[0]);return n[0]=="!"&&(n=n.substring(1)),n+"@0:"+t.percentY},this.getPageForElementCfi=function(e){var t=this.$iframe[0].contentDocument,n=this.splitCfi(e),r="epubcfi("+n.cfi+")",i=EPUBcfi.Interpreter.getTargetElementWithPartialCFI(r,t);return!i||i.length==0?(console.log("Can't find element for CFI: "+e),undefined):this.getPageForElement(i,n.x,n.y)},this.getPageForElement=function(e,t,n){var r=ReadiumSDK.Helpers.Rect.fromElement(e),i=Math.ceil(r.top+n*r.height/100),s=Math.floor(i/this.$viewport.height());return s},this.getPageForElementId=function(e){var t=this.$iframe[0].contentDocument,n=r("#"+e,t);return n.length==0?-1:this.getPageForElement(n,0,0)},this.splitCfi=function(e){var t={cfi:"",x:0,y:0},n=e.indexOf("@");if(n!=-1){var r=e.substring(n+1),i=r.indexOf(":");i!=-1?(t.x=parseInt(r.substr(0,i)),t.y=parseInt(r.substr(i+1))):console.log("Unexpected terminating step format"),t.cfi=e.substring(0,n)}else t.cfi=e;return t}},n("cfiNavigationLogic",function(){}),ReadiumSDK.Views.ReflowableView=s.View.extend({currentSpineItem:undefined,isWaitingFrameRender:!1,deferredPageRequest:undefined,spine:undefined,fontSize:100,lastViewPortSize:{width:undefined,height:undefined},paginationInfo:{visibleColumnCount:2,columnGap:20,spreadCount:0,currentSpreadIndex:0,columnWidth:undefined,pageOffset:0,columnCount:0},initialize:function(){this.spine=this.options.spine},render:function(){this.template=i.template(r("#template-reflowable-view").html(),{}),this.setElement(this.template),this.$iframe=r("#epubContentIframe",this.$el),this.$iframe.css("left",""),this.$iframe.css("right",""),this.$iframe.css(this.spine.isLeftToRight()?"left":"right","0px");var e=i.debounce(this.onViewportResize,100);return r(window).on("resize.ReadiumSDK.reflowableView",i.bind(e,this)),this},remove:function(){r(window).off("resize.ReadiumSDK.reflowableView"),s.View.prototype.remove.call(this)},isReflowable:function(){return!0},onViewportResize:function(){this.updateViewportSize()&&this.updatePagination()},setViewSettings:function(e){this.paginationInfo.visibleColumnCount=e.isSyntheticSpread?2:1,this.paginationInfo.columnGap=e.columnGap,this.fontSize=e.fontSize,this.updateHtmlFontSizeAndColumnGap(),this.updatePagination()},registerTriggers:function(e){r("trigger",e).each(function(){var t=new ReadiumSDK.Models.Trigger(this);t.subscribe(e)})},loadSpineItem:function(e){if(this.currentSpineItem!=e){this.paginationInfo.currentSpreadIndex=0,this.currentSpineItem=e,this.isWaitingFrameRender=!0;var t=this.spine.getItemUrl(e);ReadiumSDK.Helpers.LoadIframe(this.$iframe[0],t,this.onIFrameLoad,this)}},updateHtmlFontSizeAndColumnGap:function(){this.$epubHtml&&(this.$epubHtml.css("font-size",this.fontSize+"%"),this.$epubHtml.css("-webkit-column-gap",this.paginationInfo.columnGap+"px"))},onIFrameLoad:function(e){this.isWaitingFrameRender=!1;if(this.deferredPageRequest&&this.deferredPageRequest.spineItem!=this.currentSpineItem){this.loadSpineItem(this.deferredPageRequest.spineItem);return}if(!e){this.deferredPageRequest=undefined;return}var t=this.$iframe[0].contentDocument;this.$epubHtml=r("html",t),this.$epubHtml.css("height","100%"),this.$epubHtml.css("position","absolute"),this.$epubHtml.css("-webkit-column-axis","horizontal"),this.updateHtmlFontSizeAndColumnGap(),this.updateViewportSize(),this.updatePagination(),this.applySwitches(t),this.registerTriggers(t)},openDeferredElement:function(){if(!this.deferredPageRequest)return;var e=this.deferredPageRequest;this.deferredPageRequest=undefined,this.openPage(e)},openPage:function(e){if(this.isWaitingFrameRender){this.deferredPageRequest=e;return}if(e.spineItem&&e.spineItem!=this.currentSpineItem){this.deferredPageRequest=e,this.loadSpineItem(e.spineItem);return}var t=undefined,n=new ReadiumSDK.Views.CfiNavigationLogic(this.$el,this.$iframe);e.spineItemPageIndex!==undefined?t=e.spineItemPageIndex:e.elementId?t=n.getPageForElementId(e.elementId):e.elementCfi?t=n.getPageForElementCfi(e.elementCfi):e.firstPage?t=0:e.lastPage&&(t=this.paginationInfo.columnCount-1),t!==undefined&&t>=0&&t<this.paginationInfo.columnCount&&(this.paginationInfo.currentSpreadIndex=Math.floor(t/this.paginationInfo.visibleColumnCount),this.onPaginationChanged())},redraw:function(){var e=-this.paginationInfo.pageOffset+"px";this.$epubHtml.css("left",this.spine.isLeftToRight()?e:""),this.$epubHtml.css("right",this.spine.isRightToLeft()?e:"")},updateViewportSize:function(){var e=this.$el.width(),t=this.$el.height();return this.lastViewPortSize.width!==e||this.lastViewPortSize.height!==t?(this.lastViewPortSize.width=e,this.lastViewPortSize.height=t,!0):!1},applySwitches:function(e){var t=function(e){var t=e.attributes["required-namespace"];if(!t)return console.log("Encountered a case statement with no required-namespace"),!1;var n=["http://www.w3.org/1998/Math/MathML"];return i.include(n,t)};r("switch",e).each(function(){var e=!1;r("case",this).each(function(){!e&&t(this)?e=!0:r(this).remove()}),e&&r("default",this).remove()})},onPaginationChanged:function(){this.paginationInfo.pageOffset=(this.paginationInfo.columnWidth+this.paginationInfo.columnGap)*this.paginationInfo.visibleColumnCount*this.paginationInfo.currentSpreadIndex,this.redraw(),this.trigger("ViewPaginationChanged")},openPagePrev:function(){if(!this.currentSpineItem)return;if(this.paginationInfo.currentSpreadIndex>0)this.paginationInfo.currentSpreadIndex--,this.onPaginationChanged();else{var e=this.spine.prevItem(this.currentSpineItem);if(e){var t=new ReadiumSDK.Models.PageOpenRequest(e);t.setLastPage(),this.openPage(t)}}},openPageNext:function(){if(!this.currentSpineItem)return;if(this.paginationInfo.currentSpreadIndex<this.paginationInfo.spreadCount-1)this.paginationInfo.currentSpreadIndex++,this.onPaginationChanged();else{var e=this.spine.nextItem(this.currentSpineItem);if(e){var t=new ReadiumSDK.Models.PageOpenRequest(e);t.setFirstPage(),this.openPage(t)}}},updatePagination:function(){if(!this.$epubHtml)return;this.$iframe.css("width",this.lastViewPortSize.width+"px"),this.$iframe.css("height",this.lastViewPortSize.height+"px"),this.$epubHtml.css("height",this.lastViewPortSize.height+"px"),this.paginationInfo.columnWidth=(this.lastViewPortSize.width-this.paginationInfo.columnGap*(this.paginationInfo.visibleColumnCount-1))/this.paginationInfo.visibleColumnCount,this.paginationInfo.columnWidth=Math.floor(this.paginationInfo.columnWidth),this.$epubHtml.css("width",this.paginationInfo.columnWidth),this.shiftBookOfScreen(),this.$epubHtml.css("-webkit-column-width",this.paginationInfo.columnWidth+"px");var e=this;setTimeout(function(){var t=e.$epubHtml[0].scrollWidth;e.paginationInfo.columnCount=Math.round((t+e.paginationInfo.columnGap)/(e.paginationInfo.columnWidth+e.paginationInfo.columnGap)),e.paginationInfo.spreadCount=Math.ceil(e.paginationInfo.columnCount/e.paginationInfo.visibleColumnCount),e.paginationInfo.currentSpreadIndex>=e.paginationInfo.spreadCount&&(e.paginationInfo.currentSpreadIndex=e.paginationInfo.spreadCount-1),e.openDeferredElement(),e.$epubHtml.hide(),setTimeout(function(){e.$epubHtml.show(),e.onPaginationChanged()},50)},100)},shiftBookOfScreen:function(){this.spine.isLeftToRight()?this.$epubHtml.css("left",this.lastViewPortSize.width+1e3+"px"):this.$epubHtml.css("right",this.lastViewPortSize.width+1e3+"px")},getFirstVisibleElementCfi:function(){var e=Math.round(this.paginationInfo.pageOffset/(this.paginationInfo.columnWidth+this.paginationInfo.columnGap)),t=e*this.$el.height(),n=new ReadiumSDK.Views.CfiNavigationLogic(this.$el,this.$iframe);return n.getFirstVisibleElementCfi(t)},getPaginationInfo:function(){var e=new ReadiumSDK.Models.CurrentPagesInfo(this.spine.items.length,this.spine.package.isFixedLayout(),this.spine.direction);if(!this.currentSpineItem)return e;var t=this.paginationInfo.currentSpreadIndex*this.paginationInfo.visibleColumnCount;for(var n=0;n<this.paginationInfo.visibleColumnCount&&t+n<this.paginationInfo.columnCount;n++)e.addOpenPage(t+n,this.paginationInfo.columnCount,this.currentSpineItem.idref,this.currentSpineItem.index);return e},bookmarkCurrentPage:function(){return this.currentSpineItem?new ReadiumSDK.Models.BookmarkData(this.currentSpineItem.idref,this.getFirstVisibleElementCfi()):new ReadiumSDK.Models.BookmarkData("","")}}),n("reflowableView",function(){}),ReadiumSDK.Views.OnePageView=s.View.extend({currentSpineItem:undefined,spine:undefined,contentAlignment:undefined,meta_size:{width:0,height:0},initialize:function(){this.spine=this.options.spine,this.contentAlignment=this.options.contentAlignment},isDisplaying:function(){return this.currentSpineItem!=undefined},render:function(){return this.$iframe||(this.template=i.template(r("#template-ope-fixed-page-view").html(),{}),this.setElement(this.template),this.$el.addClass(this.options.class),this.$iframe=r("iframe",this.$el)),this},remove:function(){this.currentSpineItem=undefined,s.View.prototype.remove.call(this)},onIFrameLoad:function(e){if(e){var t=this.$iframe[0].contentDocument;this.$epubHtml=r("html",t),this.$epubHtml.css("overflow","hidden"),this.fitToScreen()}this.trigger("PageLoaded")},fitToScreen:function(){if(!this.isDisplaying())return;this.updateMetaSize();if(this.meta_size.width<=0||this.meta_size.height<=0)return;var e=this.$el.width(),t=this.$el.height(),n=e/this.meta_size.width,r=t/this.meta_size.height,i=Math.min(n,r),s=this.meta_size.width*i,o=this.meta_size.height*i,u=Math.floor((t-o)/2),a;this.contentAlignment=="left"?a=0:this.contentAlignment=="right"?a=e-s:a=Math.floor((e-s)/2),u<0&&(u=0),a<0&&(a=0);var f=this.generateTransformCSS(a,u,i);f.width=this.meta_size.width,f.height=this.meta_size.height,this.$epubHtml.css(f)},generateTransformCSS:function(e,t,n){var r="translate("+e+"px, "+t+"px) scale("+n+")",i={};return i["-webkit-transform"]=r,i["-webkit-transform-origin"]="0 0",i},updateMetaSize:function(){var e=this.$iframe[0].contentDocument,t=r("meta[name=viewport]",e).attr("content");t||(t=r("meta[name=viewbox]",e).attr("content"));if(t){var n=this.parseSize(t);n&&(this.meta_size.width=n.width,this.meta_size.height=n.height)}else{var i=r(e).find("img"),s=i.width(),o=i.height();s>0&&(this.meta_size.width=s,this.meta_size.height=o)}},loadSpineItem:function(e){if(this.currentSpineItem!=e){this.currentSpineItem=e;var t=this.spine.getItemUrl(e);ReadiumSDK.Helpers.LoadIframe(this.$iframe[0],t,this.onIFrameLoad,this)}},parseSize:function(e){var t=e.replace(/\s/g,"").split(","),n={};for(var r=0;r<t.length;r++){var i=t[r].split("=");i.length==2&&(n[i[0]]=i[1])}var s=Number.NaN,o=Number.NaN;return n.width&&(s=parseInt(n.width)),n.height&&(o=parseInt(n.height)),!isNaN(s)&&!isNaN(o)?{width:s,height:o}:undefined},getFirstVisibleElementCfi:function(){var e=new ReadiumSDK.Views.CfiNavigationLogic(this.$el,this.$iframe);return e.getFirstVisibleElementCfi(0)}}),n("onePageView",function(){}),ReadiumSDK.Views.FixedView=s.View.extend({leftPageView:undefined,rightPageView:undefined,centerPageView:undefined,spine:undefined,spread:undefined,pageViews:[],initialize:function(){this.spine=this.options.spine,this.spread=new ReadiumSDK.Models.Spread(this.spine),this.leftPageView=new ReadiumSDK.Views.OnePageView({spine:this.spine,"class":"left_page",contentAlignment:"right"}),this.rightPageView=new ReadiumSDK.Views.OnePageView({spine:this.spine,"class":"right_page",contentAlignment:"left"}),this.centerPageView=new ReadiumSDK.Views.OnePageView({spine:this.spine,"class":"center_page",contentAlignment:"center"}),this.pageViews.push(this.leftPageView),this.pageViews.push(this.rightPageView),this.pageViews.push(this.centerPageView),r(window).on("resize.ReadiumSDK.readerView",i.bind(this.onViewportResize,this))},isReflowable:function(){return!1},render:function(){return this.template=i.template(r("#template-fixed-view").html(),{}),this.setElement(this.template),this.$spreadWrap=r("#spread-wrap",this.$el),this},remove:function(){r(window).off("resize.ReadiumSDK.readerView"),s.View.prototype.remove.call(this)},setViewSettings:function(e){this.spread.setSyntheticSpread(e.isSyntheticSpread)},redraw:function(){var e=this,t=this.createPageLoadDeferrals([{pageView:this.leftPageView,spineItem:this.spread.leftItem},{pageView:this.rightPageView,spineItem:this.spread.rightItem},{pageView:this.centerPageView,spineItem:this.spread.centerItem}]);t.length>0&&r.when.apply(r,t).done(function(){e.onPagesLoaded()})},createPageLoadDeferrals:function(e){var t=[];for(var n=0;n<e.length;n++){var r=this.updatePageViewForItem(e[n].pageView,e[n].spineItem);r&&t.push(r)}return t},onPagesLoaded:function(){this.trigger("ViewPaginationChanged")},onViewportResize:function(){for(var e=0;e<this.pageViews.length;e++)this.pageViews[e].fitToScreen()},openPage:function(e){if(!e.spineItem)return;this.spread.openItem(e.spineItem),this.redraw()},openPagePrev:function(){this.spread.openPrev(),this.redraw()},openPageNext:function(){this.spread.openNext(),this.redraw()},updatePageViewForItem:function(e,t){if(!t)return e.isDisplaying()&&e.remove(),undefined;e.isDisplaying()||this.$spreadWrap.append(e.render().$el);var n=r.Deferred();return e.on("PageLoaded",n.resolve),e.loadSpineItem(t),n.promise()},getPaginationInfo:function(){var e=new ReadiumSDK.Models.CurrentPagesInfo(this.spine.items.length,this.spine.package.isFixedLayout(),this.spine.direction),t=[this.spread.leftItem,this.spread.rightItem,this.spread.centerItem];for(var n=0;n<t.length;n++){var r=t[n];r&&e.addOpenPage(0,1,r.idref,r.index)}return e},bookmarkCurrentPage:function(){var e=[];this.spine.isLeftToRight()?e=[this.leftPageView,this.centerPageView,this.rightPageView]:e=[this.rightPageView,this.centerPageView,this.leftPageView];for(var t=0;t<e.length;t++)if(e[t].isDisplaying()){var n=e[t].currentSpineItem.idref,r=e[t].getFirstVisibleElementCfi();return r==undefined&&(r=""),new ReadiumSDK.Models.BookmarkData(n,r)}return new ReadiumSDK.Models.BookmarkData("","")}}),n("fixedView",function(){}),ReadiumSDK.Views.ReaderView=s.View.extend({currentView:undefined,"package":undefined,spine:undefined,viewerSettings:undefined,initialize:function(){this.viewerSettings=new ReadiumSDK.Models.ViewerSettings({})},renderCurrentView:function(e){if(this.currentView){if(this.currentView.isReflowable()===e)return;this.resetCurrentView()}e?this.currentView=new ReadiumSDK.Views.ReflowableView({spine:this.spine}):this.currentView=new ReadiumSDK.Views.FixedView({spine:this.spine}),this.currentView.setViewSettings(this.viewerSettings),this.$el.append(this.currentView.render().$el);var t=this;this.currentView.on("ViewPaginationChanged",function(){var e=t.currentView.getPaginationInfo();t.trigger("PaginationChanged",e)})},resetCurrentView:function(){if(!this.currentView)return;this.currentView.off("ViewPaginationChanged"),this.currentView.remove(),this.currentView=undefined},openBook:function(e,t){this.package=new ReadiumSDK.Models.Package({packageData:e}),this.spine=this.package.spine,this.resetCurrentView();if(t)t.idref?t.spineItemPageIndex?this.openSpineItemPage(t.idref,t.spineItemPageIndex):t.elementCfi?this.openSpineItemElementCfi(t.idref,t.elementCfi):this.openSpineItemPage(t.idref,0):t.contentRefUrl&&t.sourceFileHref?this.openContentUrl(t.contentRefUrl,t.sourceFileHref):console.log("Invalid page request data: idref required!");else{var n=this.spine.first();if(n){var r=new ReadiumSDK.Models.PageOpenRequest(n);r.setFirstPage(),this.openPage(r)}}},openPageLeft:function(){this.package.spine.isLeftToRight()?this.openPagePrev():this.openPageNext()},openPageRight:function(){this.package.spine.isLeftToRight()?this.openPageNext():this.openPagePrev()},updateSettings:function(e){console.log("UpdateSettings: "+JSON.stringify(e)),this.viewerSettings.update(e);if(this.currentView){var t=this.currentView.bookmarkCurrentPage();this.currentView.setViewSettings(this.viewerSettings),t&&this.openSpineItemElementCfi(t.idref,t.elementCfi)}},openPageNext:function(){var e=this.currentView.getPaginationInfo();if(e.openPages.length==0)return;var t=e.openPages[e.openPages.length-1];if(t.spineItemPageIndex<t.spineItemPageCount-1){this.currentView.openPageNext();return}var n=this.spine.getItemById(t.idref),r=this.spine.nextItem(n);if(!r)return;var i=new ReadiumSDK.Models.PageOpenRequest(r);i.setFirstPage(),this.openPage(i)},openPagePrev:function(){var e=this.currentView.getPaginationInfo();if(e.openPages.length==0)return;var t=e.openPages[0];if(t.spineItemPageIndex>0){this.currentView.openPagePrev();return}var n=this.spine.getItemById(t.idref),r=this.spine.prevItem(n);if(!r)return;var i=new ReadiumSDK.Models.PageOpenRequest(r);i.setLastPage(),this.openPage(i)},getSpineItem:function(e){if(!e)return console.log("idref parameter value missing!"),undefined;var t=this.spine.getItemById(e);return t?t:(console.log("Spine item with id "+e+" not found!"),undefined)},openSpineItemElementCfi:function(e,t){var n=this.getSpineItem(e);if(!n)return;var r=new ReadiumSDK.Models.PageOpenRequest(n);t&&r.setElementCfi(t),this.openPage(r)},openPageIndex:function(e){if(!this.currentView)return;var t;if(this.package.isFixedLayout()){var n=this.package.spine.items[e];if(!n)return;t=new ReadiumSDK.Models.PageOpenRequest(n),t.setPageIndex(0)}else t=new ReadiumSDK.Models.PageOpenRequest(undefined),t.setPageIndex(e);this.openPage(t)},openPage:function(e){this.renderCurrentView(e.spineItem.isReflowable()),this.currentView.openPage(e)},openSpineItemPage:function(e,t){var n=this.getSpineItem(e);if(!n)return;var r=new ReadiumSDK.Models.PageOpenRequest(n);t&&r.setPageIndex(t),this.openPage(r)},openContentUrl:function(e,t){var n=ReadiumSDK.Helpers.ResolveContentRef(e,t),r=n.indexOf("#"),i,s;r>=0?(i=n.substr(0,r),s=n.substr(r+1)):(i=n,s=undefined);var o=this.spine.getItemByHref(i);if(!o)return;var u=new ReadiumSDK.Models.PageOpenRequest(o);s&&u.setElementId(s),this.openPage(u)},bookmarkCurrentPage:function(){return JSON.stringify(this.currentView.bookmarkCurrentPage())}}),n("readerView",function(){}),n("epub_renderer_module",["require","module","jquery","underscore","backbone","readiumSDK","helpers","triggers","bookmarkData","spineItem","spine","fixedPageSpread","package","viewerSettings","currentPagesInfo","pageOpenRequest","epubCfi","cfiNavigationLogic","reflowableView","onePageView","fixedView","readerView"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E){var s});var o=ReadiumSDK.Helpers.LoadIframe,u=ReadiumSDK.Models.SpineItem;ReadiumSDK.Models.SpineItem=function(e,t,n){function r(){this.media_type=e.media_type}return r.prototype=new u(e,t,n),r.constructor=r,new r};var a=function(e){return function(t,n,r,i){if(e.isPackageExploded())return o(t,n,r,i);var s=function(n){var i=this,s=i.currentSpineItem.href;e.relativeToPackageFetchFileContents(s,"text",function(o){var u=i.currentSpineItem.media_type;e.resolveInternalPackageResources(s,u,o,function(e){var s=t.contentDocument;s.replaceChild(e.documentElement,s.documentElement),r.call(i,n)})},function(e){e.message&&console.error(e.message),console.error(e),r.call(i,n)})},u=window.URL.createObjectURL(new Blob(["<html><body></body></html>"],{type:"text/html"}));return o(t,u,s,i)}},f=function(e,t,n){ReadiumSDK.Helpers.LoadIframe=a(e);var r=new ReadiumSDK.Views.ReaderView({el:t});return{openBook:function(){return r.openBook(n)},openSpineItemElementCfi:function(e,t){return r.openSpineItemElementCfi(e,t)},openSpineItemPage:function(e,t){return r.openSpineItemPage(e,t)},openPageIndex:function(e){return r.openPageIndex(e)},openPageRight:function(){return r.openPageRight()},openPageLeft:function(){return r.openPageLeft()},updateSettings:function(e){return r.updateSettings(e)},bookmarkCurrentPage:function(){return r.bookmarkCurrentPage()}}};return f}),n("Readium",["require","module","jquery","underscore","backbone","epub_fetch_module","epub_module","epub_reading_system","epub_renderer_module"],function(e,t,n,r,i,s,o,u,a){var f=function(e,t,n,r){var i=new s({packageDocumentURL:t,libDir:n}),u=new o(i,function(){var t=new a(i,e,u.getPackageData());r({openBook:function(){return t.openBook()},openSpineItemElementCfi:function(e,n){return t.openSpineItemElementCfi(e,n)},openSpineItemPage:function(e,n){return t.openSpineItemPage(e,n)},openPageIndex:function(e){return t.openPageIndex(e)},openPageRight:function(){return t.openPageRight()},openPageLeft:function(){return t.openPageLeft()},updateSettings:function(e){return t.updateSettings(e)},bookmarkCurrentPage:function(){return t.bookmarkCurrentPage()},epub:function(){return u}})})};return console.log(navigator.epubReadingSystem),f});var r=t("Readium");return r});